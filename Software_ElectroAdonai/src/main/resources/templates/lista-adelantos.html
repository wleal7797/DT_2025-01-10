<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8"/>
    <title>Lista de Adelantos</title>
    <link rel="stylesheet" href="/css/styles.css"/>
    <script>

            function filtrarTabla() {
            const filtro = document.getElementById("filtro").value.toUpperCase();
            const filas = document.querySelectorAll("table tr");

            filas.forEach((fila, index) => {
            if (index === 0) return; // Saltar encabezado
            const celdas = fila.getElementsByTagName("td");
            let coincide = false;

            for (let i = 0; i < celdas.length; i++) {
            if (celdas[i].textContent.toUpperCase().includes(filtro)) {
            coincide = true;
            break;
        }
        }

            fila.style.display = coincide ? "" : "none";
        });
        }
    function editarAdelanto(id, fecha, cantidad, estado) {
    document.getElementById("edit-id").value = id;
    document.getElementById("edit-cantidad").value = cantidad;
    document.getElementById("edit-estado").value = estado;
    document.getElementById("edit-form").style.display = "block";
    }

    function eliminarAdelanto(id) {
    if (confirm("¿Seguro que deseas eliminar este adelanto?")) {
    fetch("/adelantos/eliminar/" + id, {method: "DELETE"})
    .then((response) => response.text())
    .then((data) => {
                        alert(data);
                        location.reload();
                    })
                    .catch((error) => console.error("Error:", error));
            }
        }

        function mostrarFormularioCreacion() {
            document.getElementById("create-form").style.display = "block";
        }

        function ocultarFormularioCreacion() {
            document.getElementById("create-form").style.display = "none";
        }

            function formatearPesos(input) {
                let valor = input.value.replace(/\D/g, ""); // quitar todo lo que no sea dígito
                if (valor) {
                    input.value = new Intl.NumberFormat("es-CO").format(valor);
                } else {
                    input.value = "";
                }
            }

            function limpiarFormatoAntesDeEnviar(form) {
                const costoInput = form.querySelector("[name='COSTO']");
                costoInput.value = costoInput.value.replace(/\./g, "").replace(/\s/g, "");
            }
    </script>
</head>
<body>
<h2>Lista de Adelantos</h2>

<button onclick="mostrarFormularioCreacion()">Nuevo Adelanto</button>
<br/><br/>
<div id="create-form" style="display: none">
    <h3>Registrar Nuevo Adelanto</h3>
    <form action="/adelantos/crear" method="post" onsubmit="limpiarFormatoAntesDeEnviar(this)">
        <label>Monto del Adelanto:</label>
        <input
                type="text"
                name="CNT_ADELANTO"
                pattern="^[1-9]\d*$"
                title="Ingrese un monto válido"
                required oninput="formatearPesos(this)"
        />
        <br/>

        <label>Fecha del Adelanto:</label>
        <input type="date" name="FECHA_ADELANTO" required/>
        <br/>

        <label>Estado:</label>
        <input
                type="text"
                name="ESTADO_ADELANTO"
                pattern="^[a-zA-Z\u00C0-\u017F\s]+$"
                title="Digite un estado válido"
                required
        />
        <br/>

        <label>Empleado:</label>
        <input list="empleadoList" name="empleado.ID_EMPLEADO" required/>
        <datalist id="empleadoList">
            <option
                    th:each="emp : ${empleados}"
                    th:value="${emp.ID_EMPLEADO}"
                    th:text="${emp.NOMBRE_EMPLEADO}"
            ></option>
        </datalist>
        <br/>

        <button type="submit">Guardar</button>
        <button type="reset" onclick="ocultarFormularioCreacion()">Cancelar</button>
    </form>
    <br/>
</div>

<div class="grid-2">
    <div id="filtroContainer">
        <input type="text" id="filtro" onkeyup="filtrarTabla()" placeholder="Buscar..."
               style="width: 80%; padding: 5px; margin-right: 60px;">
    </div>
</div>

<div id="tabla-container" class="tabla-scroll">
    <table border="1">
        <tr>
            <th>Fecha</th>
            <th>Empleado</th>
            <th>Cantidad</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
        <tr th:each="adelanto : ${adelantos}">
            <td th:text="${adelanto.FECHA_ADELANTO}"></td>
            <td
                    th:text="${adelanto.empleado != null} ? ${adelanto.empleado.NOMBRE_EMPLEADO} : 'N/A'"
            ></td>
            <td th:text="${#numbers.formatCurrency(adelanto.CNT_ADELANTO)}"></td>
            <td th:text="${adelanto.ESTADO_ADELANTO}"></td>
            <td>
                <button
                        th:attr="onclick=|editarAdelanto('${adelanto.ID_ADELANTO}', '${adelanto.FECHA_ADELANTO}', '${adelanto.CNT_ADELANTO}', '${adelanto.ESTADO_ADELANTO}')|"
                >
                    Editar
                </button>
                <button th:attr="onclick=|eliminarAdelanto('${adelanto.ID_ADELANTO}')|">
                    Eliminar
                </button>
            </td>
        </tr>
    </table>
</div>

<div id="edit-form" style="display: none">
    <form th:action="@{/adelantos/editar}" method="post">
        <h3>Editar Adelanto</h3>

        <input type="hidden" id="edit-id" name="ID_ADELANTO"/>

        <label>Cantidad:</label>
        <input
                type="text"
                id="edit-cantidad"
                name="CNT_ADELANTO"
                pattern="^[1-9]\d*$"
                title="Ingrese un monto válido"
        />
        <br/>

        <label>Estado:</label>
        <input
                type="text"
                id="edit-estado"
                name="ESTADO_ADELANTO"
                pattern="^[a-zA-Z\u00C0-\u017F\s]+$"
                title="Digite un estado válido"
        />
        <br/>

        <button type="submit">Guardar</button>
        <button type="button" onclick="document.getElementById('edit-form').style.display='none'">
            Cancelar
        </button>
    </form>
</div>

<br/>
<a href="/main/main">
    <button style="padding: 5px 10px">Volver al Inicio</button>
</a>
</body>
</html>
