<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8">
  <title>Lista de Productos</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script>
    function editarProducto(id, nombre, referencia, costo, existencias) {
      document.getElementById("edit-id").value = id;
      document.getElementById("edit-nombre").value = nombre;
      document.getElementById("edit-referencia").value = referencia;
      document.getElementById("edit-costo").value = costo;
      document.getElementById("edit-existencias").value = existencias;
      document.getElementById("edit-form").style.display = "block";
    }

    function eliminarProducto(id) {
      if (confirm("Â¿Seguro que deseas eliminar este producto?")) {
        fetch('/productos/eliminar/' + id, { method: 'DELETE' })
                .then(response => response.text())
                .then(data => {
                  alert(data);
                  location.reload();
                })
                .catch(error => console.error('Error:', error));
      }
    }

    function actualizarFiltro() {
      const atributo = document.getElementById("atributo").value;
      const contenedor = document.getElementById("filtroContainer");
      contenedor.innerHTML = "";

      const input = document.createElement("input");
      input.id = "filtro";
      input.placeholder = "Buscar...";
      input.oninput = filtrarTabla;
      input.type = atributo === "costo" || atributo === "existencias" || atributo === "id" ? "number" : "text";
      contenedor.appendChild(input);
    }

    function filtrarTabla() {
      const filtro = document.getElementById("filtro").value.toUpperCase();
      const atributo = document.getElementById("atributo").value;
      const filas = document.querySelectorAll("table tr");

      filas.forEach((fila, index) => {
        if (index === 0) return; // Saltar encabezado
        const celdas = fila.getElementsByTagName("td");
        let texto = "";

        switch (atributo) {
          case "id":
            texto = celdas[0].textContent;
            break;
          case "nombre":
            texto = celdas[1].textContent;
            break;
          case "referencia":
            texto = celdas[2].textContent;
            break;
          case "costo":
            texto = celdas[3].textContent;
            break;
          case "existencias":
            texto = celdas[4].textContent;
            break;
          case "tipo":
            texto = celdas[5].textContent;
            break;
        }

        fila.style.display = texto.toUpperCase().includes(filtro) ? "" : "none";
      });
    }
  </script>
</head>
<body>
<h2>Lista de Productos</h2>

<div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
  <select id="atributo" onchange="actualizarFiltro()">
    <option value="id">ID</option>
    <option value="nombre">Nombre</option>
    <option value="referencia">Referencia</option>
    <option value="costo">Costo</option>
    <option value="existencias">Existencias</option>
    <option value="tipo">Tipo</option>
  </select>
  <div id="filtroContainer">
    <input type="text" id="filtro" oninput="filtrarTabla()" placeholder="Buscar..." style="width: 80%; padding: 5px;">
  </div>
</div>

<table border="1">
  <tr>
    <th>ID</th>
    <th>Nombre</th>
    <th>Referencia</th>
    <th>Costo</th>
    <th>Existencias</th>
    <th>Tipo</th>
    <th>Acciones</th>
  </tr>
  <tr th:each="producto : ${productos}">
    <td th:text="${producto.ID_PRODUCTO}"></td>
    <td th:text="${producto.NOMBRE_PRODUCTO}"></td>
    <td th:text="${producto.REFERENCIA}"></td>
    <td th:text="${producto.COSTO}"></td>
    <td th:text="${producto.EXISTENCIAS}"></td>
    <td th:text="${producto.ID_TIPO_PRODUCTO.NOMBRE_TIPO}"></td>
    <td>
      <button th:attr="onclick=|editarProducto('${producto.ID_PRODUCTO}', '${producto.NOMBRE_PRODUCTO}', '${producto.REFERENCIA}', '${producto.COSTO}', '${producto.EXISTENCIAS}')|">Editar</button>
      <button th:attr="onclick=|eliminarProducto('${producto.ID_PRODUCTO}')|">Eliminar</button>
    </td>
  </tr>
</table>

<div id="edit-form" style="display:none; width: 600px; padding: 0px; background-color: #fff; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin: 20px auto;">
  <form th:action="@{/productos/editar}" method="post">
    <h3>Editar Producto</h3><br>
    <input type="hidden" id="edit-id" name="ID_PRODUCTO">
    <label>Nombre: <input type="text" id="edit-nombre" name="NOMBRE_PRODUCTO"></label><br>
    <label>Referencia: <input type="text" id="edit-referencia" name="REFERENCIA"></label><br>
    <label>Costo: <input type="number" step="0.01" id="edit-costo" name="COSTO"></label><br>
    <label>Existencias: <input type="number" id="edit-existencias" name="EXISTENCIAS"></label><br>
    <button type="submit">Guardar</button>
    <button type="button" onclick="document.getElementById('edit-form').style.display='none'">Cancelar</button>
  </form>
</div>

<br>
<a href="/main/main">
  <button style="padding: 5px 10px;">Volver al Inicio</button>
</a>
</body>
</html>
